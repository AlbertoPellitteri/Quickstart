{% extends "000-base.html" %} {% block content %}
<form action="/step/120-trakt" method="post" id="configForm" name="configForm">
  <div id="sonarrSection">
    <div class="row">
      <div class="col align-self-center">
        <a class="btn btn-secondary" role="button" href="/step/start">Previous</a>
      </div>
      <div class="col-6 align-self-center text-center">
        <h2>Sonarr</h2>
      </div>
      <div class="col align-self-center">
        <div class="input-group justify-content-end">
          <a class="btn btn-success" role="button" href="/step/120-trakt">Next</a> <button type="button" class="btn btn-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false"><span class="visually-hidden">Toggle Dropdown</span></button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <a class="dropdown-item" href="/step/010-plex">Plex</a>
            </li>
            <li>
              <a class="dropdown-item" href="/step/020-tmdb">TMDb</a>
            </li>
            <li>
              <a class="dropdown-item" href="/step/030-tautulli">Tautulli</a>
            </li>
            <li>
              <a class="dropdown-item" href="/step/040-github">GitHub</a>
            </li>
            <li>
              <a class="dropdown-item" href="/step/050-omdb">OMDb</a>
            </li>
            <li>
              <a class="dropdown-item" href="/step/060-mdblist">MDBList</a>
            </li>
            <li>
              <a class="dropdown-item" href="/step/070-notifiarr">Notifiarr</a>
            </li>
            <li>
              <a class="dropdown-item" href="/step/080-gotify">Gotify</a>
            </li>
            <li>
              <a class="dropdown-item" href="/step/090-anidb">AniDB</a>
            </li>
            <li>
              <a class="dropdown-item" href="/step/100-radarr">Radarr</a>
            </li>
            <li>
              <a class="dropdown-item" href="/step/110-sonarr">Sonarr</a>
            </li>
            <li>
              <a class="dropdown-item" href="/step/120-trakt">Trakt</a>
            </li>
            <li>
              <a class="dropdown-item" href="/step/130-mal">MyAnimeList</a>
            </li>
            <li>
              <a class="dropdown-item" href="/step/140-webhooks">Webhooks</a>
            </li>
            <li>
              <a class="dropdown-item" href="/step/150-settings">Settings</a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li>
              <a class="dropdown-item" href="#">Skip to Validation (doesn't work atm)</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="container text-center">
      <div class="row">
        <div class="col"></div>
        <div class="col-8">
          <div class="col align-self-end">
            <div class="progress" role="progressbar" aria-label="Example with label" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
              <div class="progress-bar bg-success" style="width: 25%">
                25%
              </div>
            </div>
          </div>
        </div>
        <div class="col"></div>
      </div>
    </div>
    <hr class="hr">
    <div class="alert alert-info" role="alert">
      <a href="#" data-bs-toggle="modal" data-bs-target="#exampleModal">Click Here</a> if you need guidance completing this section.
    </div>
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Completing the Sonarr Section</h1>
          </div>
          <div class="modal-body">
            This is some dummy text<br>
            <br>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <div class="form-floating">
      <input type="text" class="form-control" id="sonarr_url" name="sonarr_url" placeholder="http://127.0.0.1:32400"> <label for="sonarr_url">Sonarr URL (including URL Base if set)</label>
    </div>
    <div class="input-group input-group-lg">
      <input type="password" class="form-control" id="sonarr_token" name="sonarr_token" placeholder="Token" aria-label="Token"> <button class="btn btn-secondary" id="toggleApikeyVisibility" type="button">Show</button> <button class="btn btn-success" id="validateSonarrButton" type="button">Validate</button>
    </div>
    <div id="sonarrStatusMessage" class="status-message"></div><br>
    <div class="form-floating">
      <select class="form-select" aria-label="Root Folder Path" id="sonarr_root_folder_path" name="sonarr_root_folder_path">
        <option value="">
          Select Root Folder Path
        </option>
      </select> <select class="form-select" aria-label="Monitor" id="sonarr_monitor" name="sonarr_monitor">
        <option value="all" selected>
          Select Monitor Preference
        </option>
        <option value="all">
          all (default) - monitor all episodes except specials
        </option>
        <option value="none">
          none - Do not monitor any episodes
        </option>
        <option value="future">
          future - monitor episodes that have not aired yet
        </option>
        <option value="missing">
          missing - monitor episodes that do not have files or have not aired yet
        </option>
        <option value="existing">
          existing - monitor episodes that have files or have not aired yet
        </option>
        <option value="pilot">
          pilot - monitor the first episode, all others will be ignored
        </option>
        <option value="first">
          first - monitor all episodes of the first season only
        </option>
        <option value="latest">
          latest - monitor all episodes of the latest season and future seasons
        </option>
      </select> <select class="form-select" aria-label="Quality Profile" id="sonarr_quality_profile" name="sonarr_quality_profile">
        <option value="">
          Select Quality Profile
        </option>
      </select> <select class="form-select" aria-label="Language Profile" id="sonarr_language_profile" name="sonarr_language_profile">
        <option value="">
          Select Language Profile
        </option>
      </select> <select class="form-select" aria-label="Series Type" id="sonarr_series_type" name="sonarr_series_type">
        <option value="standard" selected>
          Select Series Type
        </option>
        <option value="standard">
          Standard (default)
        </option>
        <option value="daily">
          Daily
        </option>
        <option value="anime">
          Anime
        </option>
      </select>
    </div>
    <div class="form-floating">
      <input type="text" class="form-control" id="sonarr_tag" name="sonarr_tag" placeholder=""> <label for="sonarr_tag">Tag to apply to added media</label>
    </div>
    <div class="form-floating">
      <input type="text" class="form-control" id="sonarr_sonarr_path" name="sonarr_sonarr_path" placeholder=""> <label for="sonarr_sonarr_path">Sonarr Path</label>
    </div>
    <div class="form-floating">
      <input type="text" class="form-control" id="sonarr_plex_path" name="sonarr_plex_path" placeholder=""> <label for="sonarr_plex_path">Plex Path</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" value="" id="sonarr_search" checked> <label class="form-check-label" for="sonarr_search">Search for media when added</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" value="" id="sonarr_season_folder" checked> <label class="form-check-label" for="sonarr_season_folder">Use the Season Folder option when adding new media</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" value="" id="sonarr_add_missing"> <label class="form-check-label" for="sonarr_add_missing">Add missing media from collections</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" value="" id="sonarr_add_existing"> <label class="form-check-label" for="sonarr_add_existing">Add existing media from collections</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" value="" id="sonarr_upgrade_existing"> <label class="form-check-label" for="sonarr_upgrade_existing">Upgrade existing media from collections to the Quality Profile</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" value="" id="sonarr_monitor_existing"> <label class="form-check-label" for="sonarr_monitor_existing">Set existing media from collections to monitored</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" value="" id="sonarr_cutoff_search"> <label class="form-check-label" for="sonarr_cutoff_search">Start search for cutoff unmet episodes when adding new media</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" value="" id="sonarr_ignore_cache"> <label class="form-check-label" for="sonarr_ignore_cache">Ignore Kometa's cache when adding media</label>
    </div><br>
</form>

    <script>
        async function validateSonarrApikey(apikey, url) {
            const statusApiUrl = `${url}/api/v3/system/status?apikey=${apikey}`;
            const rootFolderApiUrl = `${url}/api/v3/rootfolder?apikey=${apikey}`;
            const qualityProfileApiUrl = `${url}/api/v3/qualityprofile?apikey=${apikey}`;
            const languageProfileApiUrl = `${url}/api/v3/language?apikey=${apikey}`;
            const sonarrStatusMessage = document.getElementById('sonarrStatusMessage');

            try {
                // Validate API key
                const response = await fetch(statusApiUrl);
                const data = await response.json();
                console.log("API Response:", data);

                if (response.ok && 'version' in data) {
                    console.log("Sonarr API key is valid.");
                    sonarrStatusMessage.textContent = "Sonarr API key is valid.";
                    sonarrStatusMessage.style.color = '#75b798';
                    sonarrStatusMessage.style.display = 'block';

                    // Fetch and populate root folders
                    const rootFolderResponse = await fetch(rootFolderApiUrl);
                    const rootFolders = await rootFolderResponse.json();
                    const rootFolderSelect = document.getElementById('sonarr_root_folder_path');
                    rootFolderSelect.innerHTML = '<option value="">Select Root Folder</option>';
                    rootFolders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.path;
                        option.textContent = folder.path;
                        rootFolderSelect.appendChild(option);
                    });

                    // Fetch and populate quality profiles
                    const qualityProfileResponse = await fetch(qualityProfileApiUrl);
                    const qualityProfiles = await qualityProfileResponse.json();
                    const qualityProfileSelect = document.getElementById('sonarr_quality_profile');
                    qualityProfileSelect.innerHTML = '<option value="">Select Quality Profile</option>';
                    qualityProfiles.forEach(profile => {
                        const option = document.createElement('option');
                        option.value = profile.name;
                        option.textContent = profile.name;
                        qualityProfileSelect.appendChild(option);
                    });

                    // Fetch and populate language profiles
                    const languageProfileResponse = await fetch(languageProfileApiUrl);
                    const languageProfiles = await languageProfileResponse.json();
                    const languageProfileSelect = document.getElementById('sonarr_language_profile');
                    languageProfileSelect.innerHTML = '<option value="">Select Language Profile</option>';
                    languageProfiles
                        .sort((a, b) => a.name.localeCompare(b.name))
                        .forEach(profile => {
                            const option = document.createElement('option');
                            option.value = profile.name;
                            option.textContent = profile.name;
                            if (profile.name === 'English') {
                                option.selected = true;
                            }
                            languageProfileSelect.appendChild(option);
                        });

                    return true;
                } else {
                    console.log("Invalid Sonarr API key. Error:", data.message);
                    sonarrStatusMessage.textContent = "Sonarr API key is invalid.";
                    sonarrStatusMessage.style.color = '#ea868f';
                    sonarrStatusMessage.style.display = 'block';
                    return false;
                }
            } catch (error) {
                console.error("Error validating Sonarr apikey:", error);
                sonarrStatusMessage.textContent = 'Error validating Sonarr API key.';
                sonarrStatusMessage.style.color = '#ea868f';
                sonarrStatusMessage.style.display = 'block';
                return false;
            }
        }

        document.getElementById('validateSonarrButton').addEventListener('click', function() {
            const apiKey = document.getElementById('sonarr_token').value;
            const url = document.getElementById('sonarr_url').value;
            const sonarrStatusMessage = document.getElementById('sonarrStatusMessage');

            if (!apiKey || !url) {
                sonarrStatusMessage.textContent = 'Please enter the Sonarr API key and URL.';
                sonarrStatusMessage.style.color = '#ea868f';
                sonarrStatusMessage.style.display = 'block';
                return;
            }

            validateSonarrApikey(apiKey, url);
        });

        document.getElementById('toggleApikeyVisibility').addEventListener('click', function() {
            const apikeyInput = document.getElementById('sonarr_token');
            const currentType = apikeyInput.getAttribute('type');
            apikeyInput.setAttribute('type', currentType === 'password' ? 'text' : 'password');
            this.textContent = currentType === 'password' ? 'Hide' : 'Show';
        });
    </script> {% endblock %}