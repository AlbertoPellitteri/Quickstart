{% extends "000-base.html" %} {% block content %}
<meta id="notifiarr_available" data-notifiarr-available="{{ page_info['notifiarr_available'] }}">
<meta id="gotify_available" data-gotify-available="{{ page_info['gotify_available'] }}">
<form method="post" id="configForm" name="configForm">
  <div id="{{page_info['title']}}Section">
    <div class="row">
      <div class="col align-self-center">
        <div class="input-group justify-content-start">
          <button type="submit" class="btn btn-secondary" onclick="loading('prev')" formaction="/step/{{ page_info['prev_page'] }}">
            <span id="prev-spinner-span" class="spinner-border-sm" aria-hidden="true"></span>
            <span id="prev-spinner-text" role="status">Previous</span>
          </button>
          <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split"
            data-bs-toggle="dropdown" aria-expanded="false">
            <span class="visually-hidden">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu">
            {% for file, name in template_list %}
            {% if name == 'Final Validation' %}
            <li>
              <hr class="dropdown-divider">
            </li>
            {% endif %}
            <li>
              <a class="dropdown-item" href="/step/{{ file.rsplit('.', 1)[0] }}">{{ name }}</a>
            </li>
            {% if name == 'Start' %}
            <li>
              <hr class="dropdown-divider">
            </li>
            {% endif %}
            {% endfor %}
          </ul>
        </div>
      </div>
      <div class="col-6 align-self-center text-center">
        <h2>{{ page_info['title'] }}</h2>
      </div>
      <div class="col align-self-center">
        <div class="input-group justify-content-end">
            <button type="submit" class="btn btn-success" onclick="loading('next')" formaction="/step/{{ page_info['next_page'] }}">
            <span id="next-spinner-span" class="spinner-border-sm" aria-hidden="true"></span>
            <span id="next-spinner-text" role="status">Next</span>
          </button>
          <button type="button" class="btn btn-success dropdown-toggle dropdown-toggle-split"
            data-bs-toggle="dropdown" aria-expanded="false">
            <span class="visually-hidden">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            {% for file, name in template_list %}
            {% if name == 'Final Validation' %}
            <li>
              <hr class="dropdown-divider">
            </li>
            {% endif %}
            <li>
              <a class="dropdown-item" href="/step/{{ file.rsplit('.', 1)[0] }}">{{ name }}</a>
            </li>
            {% if name == 'Start' %}
            <li>
              <hr class="dropdown-divider">
            </li>
            {% endif %}
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    <div class="container text-center">
      <div class="row">
        <div class="col"></div>
        <div class="col-8">
          <div class="col align-self-end">
            <div class="progress" role="progressbar" aria-label="Example with label" aria-valuenow="25"
              aria-valuemin="0" aria-valuemax="100">
              <div class="progress-bar bg-success" style="width: {{ page_info['progress'] }}%">
                {{ page_info['progress'] }}%
              </div>
            </div>
          </div>
        </div>
        <div class="col"></div>
      </div>
    </div>
    <hr class="hr">
    <div class="alert alert-info" role="alert">
      <a href="#" data-bs-toggle="modal" data-bs-target="#exampleModal">Click Here</a> if you need guidance completing this section.
    </div>
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Completing the {{ page_info['title'] }} Section</h1>
          </div>
          <div class="modal-body">
            This is some dummy text<br>
            <br>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    {% for webhook in ["error", "run_start", "run_end", "changes", "version", "delete"] %}
    <div class="form-floating">
      <select class="form-select" id="webhooks_{{ webhook }}" name="webhooks_{{ webhook }}" onchange="showCustomInput(this)">
        <option value="">None</option>
        <option value="notifiarr" {% if data.webhooks[webhook] == 'notifiarr' %}selected{% endif %}>Notifiarr</option>
        <option value="gotify" {% if data.webhooks[webhook] == 'gotify' %}selected{% endif %}>Gotify</option>
        <option value="custom" {% if (data and data.webhooks[webhook] and data.webhooks[webhook].startswith('http')) %}selected{% endif %}>Custom</option>
      </select>
      <label for="webhooks_{{ webhook }}">{{ webhook|replace("_", " ")|title }} Webhook Details</label>
      <div class="input-group input-group-lg custom-webhook" id="webhooks_{{ webhook }}_custom" style="display: none;">
        <div class="input-group input-group-lg">
          <input type="text" class="form-control custom-webhook-url" placeholder="Enter webhook URL ({{ webhook|replace("_", " ")|title }})"
                 value="{% if (data and data.webhooks[webhook] and data.webhooks[webhook].startswith('http')) %}{{ data.webhooks[webhook] }}{% endif %}">
          <button class="btn btn-success" type="button">Validate</button>
        </div>
      </div>
    </div>
    {% endfor %}

    <script>
    function showCustomInput(select) {
      var customInputId = select.id + "_custom";
      var customInput = $("#" + customInputId);
      if ($(select).val() === "custom" || $(select).val().startsWith('http')) {
        customInput.show();
        customInput.find("input, button").prop("disabled", false);
      } else {
        customInput.hide();
        customInput.find("input").val("");
        customInput.find("input, button").prop("disabled", true);
      }
    }

    $(document).ready(function() {
      var notifiarrAvailable = $('#notifiarr_available').data('notifiarr-available') === "True";
      var gotifyAvailable = $('#gotify_available').data('gotify-available') === "True";

      $('select.form-select').each(function() {
        var notifiarrOption = $(this).find('option[value="notifiarr"]');
        if (!notifiarrAvailable) {
          notifiarrOption.prop('disabled', true);
        }

        var gotifyOption = $(this).find('option[value="gotify"]');
        if (!gotifyAvailable) {
          gotifyOption.prop('disabled', true);
        }

        showCustomInput(this);
      });

      $('#configForm').on('submit', function(e) {
        $('select.form-select').each(function() {
          if ($(this).val() === 'custom') {
            var customInputId = $(this).attr('id') + '_custom';
            var customUrl = $('#' + customInputId).find('input.custom-webhook-url').val();
            $(this).append('<option value="' + customUrl + '" selected="selected">' + customUrl + '</option>');
            $(this).val(customUrl);
          }
        });
      });
    });
    </script>
  </div>
</form>
{% endblock %}
