{% extends "000-base.html" %}

{% block content %}
    <h1>Radarr Configuration Information</h1>
    <form action="/step/110-sonarr" method="post" id="configForm">
        <!-- Radarr Section -->
        <div id="radarrSection">
            <h2>Radarr Settings</h2>
            
            <label for="radarr_url">Radarr URL:</label>
            <input type="text" id="radarr_url" name="radarr_url" placeholder="http://192.168.1.12:7878">

            <label for="radarr_token">Radarr Token:</label>
            <div class="button-container">
                <input type="password" id="radarr_token" name="radarr_token" placeholder="################################">
                <button type="button" id="toggleApikeyVisibility" class="btn btn-primary btn-sm">Show</button>
                <button type="button" id="validateRadarrButton" class="btn btn-success btn-sm">Validate</button>
            </div>
            <div id="radarrStatusMessage" class="status-message" style="display: none;"></div>
            
            <label for="radarr_root_folder_path">Root Folder Path:</label>
            <select id="radarr_root_folder_path" name="radarr_root_folder_path">
                <option value="">Select Root Folder</option>
            </select>
            
            <label for="radarr_quality_profile">Quality Profile:</label>
            <select id="radarr_quality_profile" name="radarr_quality_profile">
                <option value="">Select Quality Profile</option>
            </select>
            
            <label for="radarr_availability">Availability:</label>
            <select id="radarr_availability" name="radarr_availability">
                <option value="announced">Announced</option>
                <option value="cinemas">Cinemas</option>
                <option value="released">Released</option>
                <option value="db">DB</option>
            </select>
            
            <label for="radarr_tag">Tag:</label>
            <input type="text" id="radarr_tag" name="radarr_tag">

            <label for="radarr_radarr_path">Radarr Path:</label>
            <input type="text" id="radarr_radarr_path" name="radarr_radarr_path">

            <label for="radarr_plex_path">Plex Path:</label>
            <input type="text" id="radarr_plex_path" name="radarr_plex_path">
            
            <div class="checkbox-container">
                <label for="radarr_monitor">Monitor:</label>
                <input type="checkbox" id="radarr_monitor" name="radarr_monitor" checked>
            </div>
            <div class="checkbox-container">
                <label for="radarr_search">Search:</label>
                <input type="checkbox" id="radarr_search" name="radarr_search">
            </div>
            <div class="checkbox-container">
                <label for="radarr_add_missing">Add Missing:</label>
                <input type="checkbox" id="radarr_add_missing" name="radarr_add_missing">
            </div>
            <div class="checkbox-container">
                <label for="radarr_add_existing">Add Existing:</label>
                <input type="checkbox" id="radarr_add_existing" name="radarr_add_existing">
            </div>
            <div class="checkbox-container">
                <label for="radarr_upgrade_existing">Upgrade Existing:</label>
                <input type="checkbox" id="radarr_upgrade_existing" name="radarr_upgrade_existing">
            </div>
            <div class="checkbox-container">
                <label for="radarr_monitor_existing">Monitor Existing:</label>
                <input type="checkbox" id="radarr_monitor_existing" name="radarr_monitor_existing">
            </div>
            <div class="checkbox-container">
                <label for="radarr_ignore_cache">Ignore Cache:</label>
                <input type="checkbox" id="radarr_ignore_cache" name="radarr_ignore_cache">
            </div>
        </div>

        <br><br>
        <input type="submit" value="Next">
    </form>

    <script>
        async function validateRadarrApikey(apikey, url) {
            const statusApiUrl = `${url}/api/v3/system/status?apikey=${apikey}`;
            const rootFolderApiUrl = `${url}/api/v3/rootfolder?apikey=${apikey}`;
            const qualityProfileApiUrl = `${url}/api/v3/qualityprofile?apikey=${apikey}`;
            const radarrStatusMessage = document.getElementById('radarrStatusMessage');

            try {
                // Validate API key
                const response = await fetch(statusApiUrl);
                const data = await response.json();
                console.log("API Response:", data);

                if (response.ok && 'version' in data) {
                    console.log("Radarr API key is valid.");
                    radarrStatusMessage.textContent = "Radarr API key is valid.";
                    radarrStatusMessage.style.color = 'green';
                    radarrStatusMessage.style.display = 'block';

                    // Fetch and populate root folders
                    const rootFolderResponse = await fetch(rootFolderApiUrl);
                    const rootFolders = await rootFolderResponse.json();
                    const rootFolderSelect = document.getElementById('radarr_root_folder_path');
                    rootFolderSelect.innerHTML = '<option value="">Select Root Folder</option>';
                    rootFolders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.path;
                        option.textContent = folder.path;
                        rootFolderSelect.appendChild(option);
                    });

                    // Fetch and populate quality profiles
                    const qualityProfileResponse = await fetch(qualityProfileApiUrl);
                    const qualityProfiles = await qualityProfileResponse.json();
                    const qualityProfileSelect = document.getElementById('radarr_quality_profile');
                    qualityProfileSelect.innerHTML = '<option value="">Select Quality Profile</option>';
                    qualityProfiles.forEach(profile => {
                        const option = document.createElement('option');
                        option.value = profile.name;
                        option.textContent = profile.name;
                        qualityProfileSelect.appendChild(option);
                    });

                    return true;
                } else {
                    console.log("Invalid Radarr API key. Error:", data.message);
                    radarrStatusMessage.textContent = "Radarr API key is invalid.";
                    radarrStatusMessage.style.color = 'red';
                    radarrStatusMessage.style.display = 'block';
                    return false;
                }
            } catch (error) {
                console.error("Error validating Radarr apikey:", error);
                radarrStatusMessage.textContent = 'Error validating Radarr API key.';
                radarrStatusMessage.style.color = 'red';
                radarrStatusMessage.style.display = 'block';
                return false;
            }
        }

        document.getElementById('validateRadarrButton').addEventListener('click', function() {
            const apiKey = document.getElementById('radarr_token').value;
            const url = document.getElementById('radarr_url').value;
            const radarrStatusMessage = document.getElementById('radarrStatusMessage');

            if (!apiKey || !url) {
                radarrStatusMessage.textContent = 'Please enter the Radarr API key and URL.';
                radarrStatusMessage.style.color = 'red';
                radarrStatusMessage.style.display = 'block';
                return;
            }

            validateRadarrApikey(apiKey, url);
        });

        document.getElementById('toggleApikeyVisibility').addEventListener('click', function() {
            const apikeyInput = document.getElementById('radarr_token');
            const currentType = apikeyInput.getAttribute('type');
            apikeyInput.setAttribute('type', currentType === 'password' ? 'text' : 'password');
            this.textContent = currentType === 'password' ? 'Hide' : 'Show';
        });
    </script>
{% endblock %}