{% extends "000-base.html" %} {% block content %}
<form action="/step/{{ next_page }}" method="post" id="configForm" name="configForm">
  <div id="{{curr_page}}Section">
    <div class="row">
      <div class="col align-self-center">
        <div class="input-group justify-content-start">
          <a class="btn btn-secondary" role="button" href="/step/{{ prev_page }}">Previous</a>
          <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
            <span class="visually-hidden">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu">
            {% for file, name in template_list %}
              {% if name == 'Final Validation' %}
                <li><hr class="dropdown-divider"></li>
              {% endif %}
              <li>
                <a class="dropdown-item" href="/step/{{ file.rsplit('.', 1)[0] }}">{{ name }}</a>
              </li>
              {% if name == 'Start' %}
                <li><hr class="dropdown-divider"></li>
              {% endif %}
            {% endfor %}
          </ul>
        </div>
      </div>
      <div class="col-6 align-self-center text-center">
          <h2>{{ curr_page }}</h2>
      </div>
      <div class="col align-self-center">
        <div class="input-group justify-content-end">
          <button type="submit" class="btn btn-success">Next</button>
          <button type="button" class="btn btn-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
            <span class="visually-hidden">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            {% for file, name in template_list %}
              {% if name == 'Final Validation' %}
                <li><hr class="dropdown-divider"></li>
              {% endif %}
              <li>
                <a class="dropdown-item" href="/step/{{ file.rsplit('.', 1)[0] }}">{{ name }}</a>
              </li>
              {% if name == 'Start' %}
                <li><hr class="dropdown-divider"></li>
              {% endif %}
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    <div class="container text-center">
      <div class="row">
        <div class="col"></div>
        <div class="col-8">
          <div class="col align-self-end">
            <div class="progress" role="progressbar" aria-label="Example with label" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
              <div class="progress-bar bg-success" style="width: {{ progress }}%">
                {{ progress }}%
              </div>
            </div>
          </div>
        </div>
        <div class="col"></div>
      </div>
    </div>
    <hr class="hr">
    <div class="alert alert-danger" role="alert">
      This section is mandatory and must be completed<br>
      <a href="#" data-bs-toggle="modal" data-bs-target="#exampleModal">Click Here</a> if you need guidance completing this section.
    </div>
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Completing the {{ title}} Section</h1>
          </div>
          <div class="modal-body">
            <a href="https://kometa.wiki/en/latest/config/plex/">Click Here</a> to visit the wiki for this connector<br>
            <br>
            Filling in your Plex URL and Token is mandatory as Kometa cannot run without access to a Plex Media Server.<br>
            <br>
            You cannot use <code>https://app.plex.tv</code> as your URL as that is invalid, you must provide the direct address you use to access your server.<br>
            <br>
            If you need help finding your Plex Authentication Token, please see Plex's <a href="https://support.plex.tv/articles/204059436-finding-an-authentication-token-x-plex-token/">support article</a>. Do not use the Plex Token found in Plex's <code>Preferences.xml</code> file and do not use the token that you get via <code>https://app.plex.tv</code>.<br>
            <br>
            You should press the <code>Validate</code> button to ensure that your URL and Token combination is valid and reachable. Once successfully connected, the wizard will fetch the Database Cache size and update the field in the form.<br>
            <br>
            Please note that using the <code>Optimize Database</code> option can make Plex unresponsive, as it is generally not contactable whilst it performs its optimizations. This is expected behavior.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <div class="form-floating">
      <input type="text" class="form-control" id="plex_url" name="plex_url" value="{{ data['plex']['url'] }}" title="http://127.0.0.1:32400" required=""> <label for="plex_url">Plex URL</label>
    </div>
    <div class="input-group input-group-lg">
      <input type="password" class="form-control" id="plex_token" name="plex_token" placeholder="{{ data['plex']['token'] }}" title="Token" aria-label="Plex Token" required=""> <button class="btn btn-secondary" id="toggleApikeyVisibility" type="button">Show</button> <button class="btn btn-success" id="validatePlexButton" type="button">Validate</button>
    </div>
    <div id="plexStatusMessage" class="status-message"></div>
    <div class="hidden" id="hidden" style="display:none">
      <div class="form-floating">
      <input type="number" class="form-control" id="plex_db_cache" name="plex_db_cache" value="{{ data['plex']['db_cache'] }}" title="Set the size of the Plex Database Cache (in Megabytes), default is 40" min="40" required=""> <label for="plex_db_cache">Database Cache Size (in mb)</label>
    </div>
    <div class="form-floating">
      <input type="number" class="form-control" id="plex_timeout" name="plex_timeout" value="{{ data['plex']['timeout'] }}" title="Amount of seconds to wait for Plex to respond, default is 60" min="60" required=""> <label for="plex_timeout">Timeout (in seconds)</label>
    </div>

    <!-- Checkbox handling -->
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" name="plex_verify_ssl" id="plex_verify_ssl" value="true" {% if data['plex']['verify_ssl']|string|lower == 'true' %}checked{% endif %}>
      <input type="hidden" name="plex_verify_ssl" value="false">
      <label class="form-check-label" for="plex_verify_ssl">Verify SSL</label>
    </div>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" name="plex_clean_bundles" id="plex_clean_bundles" value="true" {% if data['plex']['clean_bundles']|string|lower == 'true' %}checked{% endif %}>
      <input type="hidden" name="plex_clean_bundles" value="false">
      <label class="form-check-label" for="plex_clean_bundles">Clean bundles</label>
    </div>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" name="plex_empty_trash" id="plex_empty_trash" value="true" {% if data['plex']['empty_trash']|string|lower == 'true' %}checked{% endif %}>
      <input type="hidden" name="plex_empty_trash" value="false">
      <label class="form-check-label" for="plex_empty_trash">Empty trash</label>
    </div>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" name="plex_optimize" id="plex_optimize" value="true" {% if data['plex']['optimize']|string|lower == 'true' %}checked{% endif %}>
      <input type="hidden" name="plex_optimize" value="false">
      <label class="form-check-label" for="plex_optimize">Optimize database</label>
    </div>
  </div>
</div>
</form>
<script>
  // Show token by default
  document.addEventListener('DOMContentLoaded', function() { // Ensure the DOM is ready
    const apikeyInput = document.getElementById('plex_token');
    const toggleButton = document.getElementById('toggleApikeyVisibility');

    // Initially show the password
    apikeyInput.setAttribute('type', 'text');
    toggleButton.textContent = 'Hide'; // Update button text

    toggleButton.addEventListener('click', function() {
      const currentType = apikeyInput.getAttribute('type');
      apikeyInput.setAttribute('type', currentType === 'password' ? 'text' : 'password');
      this.textContent = currentType === 'password' ? 'Hide' : 'Show';
    });
  });

  // Plex validation script
  document.getElementById('validatePlexButton').addEventListener('click', function() {
    const plexUrl = document.getElementById('plex_url').value;
    const plexToken = document.getElementById('plex_token').value;
    const plexStatusMessage = document.getElementById('plexStatusMessage');

    if (!plexUrl || !plexToken) {
      plexStatusMessage.textContent = 'Please enter both Plex URL and Token.';
      plexStatusMessage.style.display = 'block';
      return;
    }

    fetch('/validate_plex', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        plex_url: plexUrl,
        plex_token: plexToken
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.valid) {
        document.getElementById('plex_db_cache').value = data.db_cache;
        plexStatusMessage.textContent = 'Plex server validated successfully!';
        plexStatusMessage.style.color = '#75b798';
        var T = document.getElementById("hidden");
        T.style.display = "block";  //
      } else {
        plexStatusMessage.textContent = 'Failed to validate Plex server. Please check your URL and Token.';
        plexStatusMessage.style.color = '#ea868f';
      }
      plexStatusMessage.style.display = 'block';
    })
    .catch(error => {
      console.error('Error validating Plex server:', error);
      plexStatusMessage.textContent = 'An error occurred while validating Plex server.';
      plexStatusMessage.style.color = '#ea868f';
      plexStatusMessage.style.display = 'block';
    });
  });
</script>
{% endblock %}
