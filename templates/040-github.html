{% extends "000-base.html" %} {% block content %}
<form action="/step/050-omdb" method="post" id="configForm" name="configForm">
  <div id="githubSection">
    <h2>GitHub Settings</h2>
    <div class="form-divider"></div>
    <div class="hstack gap-3" style="width: 536px;">
      <div class="form-floating">
        <input type="password" class="form-control" id="github_token" name="github_token" placeholder="####################"> <label for="github_token">GitHub Token</label>
      </div>
      <button type="button" id="toggleApikeyVisibility" class="btn btn-primary btn-sm">Show</button>
      <div class="vr"></div>
      <button type="button" id="validateGithubButton" class="btn btn-success btn-sm">Validate</button>
    </div>
        <div id="githubStatusMessage" class="status-message"></div>
      </div><br>
      <br>
  <nav aria-label="Page navigation example">
    <ul class="pagination justify-content-center">
      <div class="d-grid gap-2 d-md-block">
        <a class="btn btn-primary" role="button" href="/step/030-tautulli">⏪ Previous</a> <button class="btn btn-primary me-md-2" type="submit">Next ⏩</button>
      </div>
    </ul>
  </nav>
    </div>
  </div>
</form>
<script>
      document.getElementById('toggleApikeyVisibility').addEventListener('click', function() {
        const apikeyInput = document.getElementById('github_token');
        const currentType = apikeyInput.getAttribute('type');
        apikeyInput.setAttribute('type', currentType === 'password' ? 'text' : 'password');
        this.textContent = currentType === 'password' ? 'Hide' : 'Show';
    });
        async function validateGitHubToken(token) {
  const apiUrl = "https://api.github.com/user";

  try {
    const response = await fetch(apiUrl, {
      method: "GET",
      headers: {
        "Authorization": `token ${token}`,
        "Accept": "application/vnd.github.v3+json"
      }
    });

    if (response.ok) {
      const data = await response.json();
      console.log("GitHub token is valid. User: " + data.login);
      return true;
    } else {
      console.log("Invalid GitHub token. Status:", response.status);
      return false;
    }
  } catch (error) {
    console.error("Error validating GitHub token:", error);
    return false;
  }
}

    document.getElementById('validateGithubButton').addEventListener('click', function() {
        const apiKey = document.getElementById('github_token').value;
        const githubStatusMessage = document.getElementById('githubStatusMessage');

        const token = "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";

        if (!apiKey) {
            githubStatusMessage.textContent = 'Please enter an Github Personal Access Token.';
            githubStatusMessage.style.display = 'block';
            return;
        }

        validateGitHubToken(apiKey).then(isValid => {
          if (isValid) {
            githubStatusMessage.textContent = "GitHub token is valid.";
            githubStatusMessage.style.color = 'green';
          } else {
            githubStatusMessage.textContent = "GitHub token is invalid.";
            githubStatusMessage.style.color = 'red';
          }
        });
        githubStatusMessage.style.display = 'block';

        });

        document.getElementById('configForm').addEventListener('submit', function(event) {
          const apiKeyInput = document.getElementById('github_token');
          if (!apiKeyInput.value) {
              apiKeyInput.value = '';
          }
      });
</script> {% endblock %}