{% extends "000-base.html" %} {% block content %}
<form action="/step/030-tautulli" method="post" id="configForm" name="configForm">
  <div id="tmdbSection">
    <h2>TMDb Settings</h2>
    <div class="form-divider"></div>
    <div class="container text-center">
      <div class="row align-items-start">
        <div class="row">
          <div class="col-8">
            <div class="form-floating">
              <input type="password" class="form-control" id="tmdb_apikey" name="tmdb_apikey" placeholder="################################" required=""> <label for="tmdb_apikey">API Key</label>
            </div>
          </div>
          <div class="col-4">
            <button type="button" id="toggleApikeyVisibility" class="btn btn-primary btn-sm">Show</button> <button type="button" id="validateButton" class="btn btn-success btn-sm">Validate</button>
          </div>
        </div>
      </div>
    </div>
    <div id="statusMessage" class="status-message"></div>
    <div class="container text-center">
      <div class="row align-items-start">
        <div class="col">
          <select class="form-select form-select-lg mb-3" aria-label="TMDb Language Selector" id="tmdb_language" name="tmdb_language">
            <option value="en">
              Language - Please validate your TMDB API Key
            </option>
          </select>
        </div>
      </div>
    </div>
    <div class="container text-center">
      <div class="row align-items-start">
        <div class="col">
          <select class="form-select form-select-lg mb-3" aria-label="TMDB Region Selector" id="tmdb_region" name="tmdb_region">
            <option value="en">
              Region - Please validate your TMDB API Key
            </option>
            <script>
            document.getElementById('toggleApikeyVisibility').addEventListener('click', function() {
            const apikeyInput = document.getElementById('tmdb_apikey');
            const currentType = apikeyInput.getAttribute('type');
            apikeyInput.setAttribute('type', currentType === 'password' ? 'text' : 'password');
            this.textContent = currentType === 'password' ? 'Hide' : 'Show';
            });
            function sortDataByISO (data){
            let sortedData;
            sortedData = data.sort(function(a,b){
            let x = a.iso_639_1.toLowerCase();
            let y = b.iso_639_1.toLowerCase();
            if(x>y){return 1;}
            if(x<y){return -1;}
            return 0;
            });
            return sortedData;
            }
            // API key validation script
            document.getElementById('validateButton').addEventListener('click', function() {
            const apiKey = document.getElementById('tmdb_apikey').value;
            const statusMessage = document.getElementById('statusMessage');
            const languageSelect = document.getElementById('tmdb_language');
            const regionSelect = document.getElementById('tmdb_region');

            if (!apiKey) {
            statusMessage.textContent = 'Please enter an API key.';
            statusMessage.style.display = 'block';
            return;
            }

            fetch(`https://api.themoviedb.org/3/movie/550?api_key=${apiKey}`)
            .then(response => {
                if (response.ok) {
                    statusMessage.textContent = 'API key is valid!';
                    statusMessage.style.color = 'green';
                    return Promise.all([
                        fetch(`https://api.themoviedb.org/3/configuration/languages?api_key=${apiKey}`),
                        fetch(`https://api.themoviedb.org/3/watch/providers/regions?api_key=${apiKey}`)
                    ]);
                } else {
                    throw new Error('Invalid API key');
                }
            })
            .then(responses => Promise.all(responses.map(response => response.json())))
            .then(data => {
                const [languagesData, regionsData] = data;

                // Clear previous options
                languageSelect.innerHTML = '';
                regionSelect.innerHTML = '';

                sortedData = sortDataByISO(languagesData)

                // Populate the language dropdown
                sortedData.forEach(language => {
                    const option = document.createElement('option');
                    option.value = language.iso_639_1;
                    if (language.name) {
                        if (language.name.startsWith("?")) {
                            option.textContent = language.english_name;
                        } else {
                            option.textContent = language.name;
                        }
                    } else {
                        option.textContent = language.english_name;
                    }
                    languageSelect.appendChild(option);
                });

                // Populate the region dropdown
                regionsData.results.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region.iso_3166_1;
                    if (region.native_name && region.native_name !== "?????") {
                        option.textContent = region.native_name;
                    } else {
                        option.textContent = region.english_name;
                    }
                    regionSelect.appendChild(option);
                });

                // Set default language and region to English
                languageSelect.value = 'en';
                regionSelect.value = 'US';
            })
            .catch(error => {
                statusMessage.textContent = error.message;
                statusMessage.style.color = 'red';
            })
            .finally(() => {
                statusMessage.style.display = 'block';
            });
            });
            </script>
          </select>
        </div>
      </div>
    </div>
  </div>
  <div class="container text-center">
    <div class="row align-items-start">
      <div class="col">
        <div class="form-floating">
          <input type="text" class="form-control" id="tmdb_cache_expiration" name="tmdb_cache_expiration" value="60" min="0"> <label for="tmdb_cache_expiration">TMDb Cache Expiration (in days)</label>
        </div>
      </div>
    </div>
  </div><br>
  <br>
  <input type="submit" value="Next">
</form>{% endblock %}