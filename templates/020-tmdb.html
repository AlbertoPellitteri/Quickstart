{% extends "000-base.html" %}

{% block content %}
    <form action="/step/030-tautulli" method="post" id="configForm" name="configForm">
        <div id="tmdbSection">
            <h2>TMDb Settings</h2>
            <div class="form-divider"></div>
            <div class="container text-center">
                <div class="row align-items-start">
                    <div class="row">
                        <div class="col-8">
                            <div class="form-floating">
                                <input type="password" class="form-control" id="tmdb_apikey" name="tmdb_apikey" placeholder="################################" required="">
                                <label for="tmdb_apikey">API Key</label>
                            </div>
                        </div>
                        <div class="col-4">
                            <button type="button" id="toggleApikeyVisibility" class="btn btn-primary btn-sm">Show</button>
                            <button type="button" id="validateButton" class="btn btn-success btn-sm">Validate</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="statusMessage" class="status-message"></div>
            <div class="container text-center">
                <div class="row align-items-start">
                    <div class="col">
                        <select class="form-select form-select-lg mb-3" aria-label="TMDb Language Selector" id="tmdb_language" name="tmdb_language">
                            <option value="en">Language - Please validate your TMDb API Key</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="container text-center">
                <div class="row align-items-start">
                    <div class="col">
                        <select class="form-select form-select-lg mb-3" aria-label="TMDb Region Selector" id="tmdb_region" name="tmdb_region">
                            <option value="EN">Region - Please validate your TMDb API Key</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="container text-center">
            <div class="row align-items-start">
                <div class="col">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="tmdb_cache_expiration" name="tmdb_cache_expiration" value="60" min="0">
                        <label for="tmdb_cache_expiration">TMDb Cache Expiration (in days)</label>
                    </div>
                </div>
            </div>
            <br>
            <br>
            <div class="d-grid gap-2 d-md-block">
                <a class="btn btn-primary" role="button" href="/step/010-plex"> ⏪ Previous</a>
                <button class="btn btn-primary me-md-2" type="submit">Next ⏩</button>
            </div>
        </div>
    </form>

    <script>
        document.getElementById('toggleApikeyVisibility').addEventListener('click', function() {
            const apikeyInput = document.getElementById('tmdb_apikey');
            const currentType = apikeyInput.getAttribute('type');
            apikeyInput.setAttribute('type', currentType === 'password' ? 'text' : 'password');
            this.textContent = currentType === 'password' ? 'Hide' : 'Show';
        });

        function sortByEnglishName(data) {
            return data.sort((a, b) => a.english_name.localeCompare(b.english_name));
        }

        document.getElementById('validateButton').addEventListener('click', function() {
            const apiKey = document.getElementById('tmdb_apikey').value;
            const statusMessage = document.getElementById('statusMessage');
            const languageSelect = document.getElementById('tmdb_language');
            const regionSelect = document.getElementById('tmdb_region');

            if (!apiKey) {
                statusMessage.textContent = 'Please enter an API key.';
                statusMessage.style.display = 'block';
                return;
            }

            fetch(`https://api.themoviedb.org/3/movie/550?api_key=${apiKey}`)
                .then(response => {
                    if (response.ok) {
                        statusMessage.textContent = 'API key is valid!';
                        statusMessage.style.color = 'green';
                        return Promise.all([
                            fetch(`https://api.themoviedb.org/3/configuration/languages?api_key=${apiKey}`),
                            fetch(`https://api.themoviedb.org/3/watch/providers/regions?api_key=${apiKey}`)
                        ]);
                    } else {
                        throw new Error('Invalid API key');
                    }
                })
                .then(responses => Promise.all(responses.map(response => response.json())))
                .then(data => {
                    const [languagesData, regionsData] = data;

                    // Clear previous options
                    languageSelect.innerHTML = '';
                    regionSelect.innerHTML = '';

                    const sortedLanguages = sortByEnglishName(languagesData);
                    const sortedRegions = sortByEnglishName(regionsData.results);

                    // Populate the language dropdown
                    sortedLanguages.forEach(language => {
                        if (language.english_name) {
                            const option = document.createElement('option');
                            option.value = language.iso_639_1;
                            option.textContent = language.english_name;
                            languageSelect.appendChild(option);
                        }
                    });

                    // Populate the region dropdown
                    sortedRegions.forEach(region => {
                        if (region.english_name) {
                            const option = document.createElement('option');
                            option.value = region.iso_3166_1;
                            option.textContent = region.english_name;
                            regionSelect.appendChild(option);
                        }
                    });

                    // Set default language and region to English
                    languageSelect.value = 'en';
                    regionSelect.value = 'US';
                })
                .catch(error => {
                    statusMessage.textContent = error.message;
                    statusMessage.style.color = 'red';
                })
                .finally(() => {
                    statusMessage.style.display = 'block';
                });
        });

        document.getElementById('configForm').addEventListener('submit', function(event) {
            const apiKeyInput = document.getElementById('tmdb_apikey');
            if (!apiKeyInput.value) {
                apiKeyInput.value = '';
            }
        });
    </script>
{% endblock %}
